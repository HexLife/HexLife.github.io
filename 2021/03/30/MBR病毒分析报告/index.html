<!DOCTYPE html><html lang="en" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>MBR病毒分析报告 | Hexo</title><meta name="description" content="基本信息报告名称：MBR病毒分析报告 报告更新日期：2019&#x2F;11&#x2F;04 样本发现日期：2019&#x2F;10&#x2F;20 样本格式：.exe 壳信息：ASPack壳 可能受到威胁的系统：Windows系列 分析环境及工具：win7 32位，BCompare，ProcessMonitor，火绒剑     FileName FileType FileSize MD5 SHA1    CF77CFFF025C3C0"><meta name="author" content="John Doe"><meta name="copyright" content="John Doe"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta http-equiv="Cache-Control" content="no-transform"><meta http-equiv="Cache-Control" content="no-siteapp"><link rel="shortcut icon" href="/img/favicon.png"><link rel="canonical" href="http://example.com/2021/03/30/MBR%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//busuanzi.ibruce.info"/><meta property="og:type" content="article"><meta property="og:title" content="MBR病毒分析报告"><meta property="og:url" content="http://example.com/2021/03/30/MBR%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/"><meta property="og:site_name" content="Hexo"><meta property="og:description" content="基本信息报告名称：MBR病毒分析报告 报告更新日期：2019&#x2F;11&#x2F;04 样本发现日期：2019&#x2F;10&#x2F;20 样本格式：.exe 壳信息：ASPack壳 可能受到威胁的系统：Windows系列 分析环境及工具：win7 32位，BCompare，ProcessMonitor，火绒剑     FileName FileType FileSize MD5 SHA1    CF77CFFF025C3C0"><meta property="og:image" content="http://example.com/null"><meta property="article:published_time" content="2021-03-30T05:45:25.000Z"><meta property="article:modified_time" content="2021-03-30T11:05:22.196Z"><meta name="twitter:card" content="summary"><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free/css/all.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.css"><script>var GLOBAL_CONFIG = { 
  root: '/',
  hexoversion: '5.2.0',
  algolia: undefined,
  localSearch: undefined,
  translate: undefined,
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true},
  copy: {
    success: 'Copy successfully',
    error: 'Copy error',
    noSupport: 'The browser does not support'
  },
  bookmark: {
    message_prev: 'Press',
    message_next: 'to bookmark this page'
  },
  runtime: '',
  date_suffix: {"one_hour":"Just","hours":"hours ago","day":"days ago"},
  copyright: undefined,
  ClickShowText: undefined,
  medium_zoom: false,
  fancybox: true,
  Snackbar: undefined,
  justifiedGallery: {
    js: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/js/jquery.justifiedGallery.min.js',
    css: 'https://cdn.jsdelivr.net/npm/justifiedGallery/dist/css/justifiedGallery.min.css'
  },
  baiduPush: false,
  isPhotoFigcaption: false,
  islazyload: false,
  isanchor: false
};

var saveToLocal = {
  set: function setWithExpiry(key, value, ttl) {
    const now = new Date()
    const expiryDay = ttl * 86400000
    const item = {
      value: value,
      expiry: now.getTime() + expiryDay,
    }
    localStorage.setItem(key, JSON.stringify(item))
    },

  get: function getWithExpiry(key) {
    const itemStr = localStorage.getItem(key)

    if (!itemStr) {
      return undefined
    }
    const item = JSON.parse(itemStr)
    const now = new Date()

    if (now.getTime() > item.expiry) {
      localStorage.removeItem(key)
      return undefined
    }
    return item.value
  }
}</script><script id="config_change">var GLOBAL_CONFIG_SITE = { 
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isSidebar: true,
  postUpdate: '2021-03-30 19:05:22'
}</script><noscript><style type="text/css">
#nav {
  opacity: 1
}
.justified-gallery img {
  opacity: 1
}
</style></noscript><script>var activateDarkMode = function () {
  document.documentElement.setAttribute('data-theme', 'dark')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
  }
}
var activateLightMode = function () {
  document.documentElement.setAttribute('data-theme', 'light')
  if (document.querySelector('meta[name="theme-color"]') !== null) {
    document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
  }
}

var autoChangeMode = 'false'
var t = saveToLocal.get('theme')
if (autoChangeMode === '1') {
  var isDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches
  var isLightMode = window.matchMedia('(prefers-color-scheme: light)').matches
  var isNotSpecified = window.matchMedia('(prefers-color-scheme: no-preference)').matches
  var hasNoSupport = !isDarkMode && !isLightMode && !isNotSpecified

  if (t === undefined) {
    if (isLightMode) activateLightMode()
    else if (isDarkMode) activateDarkMode()
    else if (isNotSpecified || hasNoSupport) {
      var now = new Date()
      var hour = now.getHours()
      var isNight = hour <= 6 || hour >= 18
      isNight ? activateDarkMode() : activateLightMode()
    }
    window.matchMedia('(prefers-color-scheme: dark)').addListener(function (e) {
      if (saveToLocal.get('theme') === undefined) {
        e.matches ? activateDarkMode() : activateLightMode()
      }
    })
  } else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else if (autoChangeMode === '2') {
  now = new Date()
  hour = now.getHours()
  isNight = hour <= 6 || hour >= 18
  if (t === undefined) isNight ? activateDarkMode() : activateLightMode()
  else if (t === 'light') activateLightMode()
  else activateDarkMode()
} else {
  if (t === 'dark') activateDarkMode()
  else if (t === 'light') activateLightMode()
}</script><meta name="generator" content="Hexo 5.2.0"></head><body><div id="mobile-sidebar"><div id="menu_mask"></div><div id="mobile-sidebar-menus"><div class="mobile_author_icon"><img class="avatar-img" src="/null" onerror="onerror=null;src='/img/friend_404.gif'" alt="avatar"/></div><div class="mobile_post_data"><div class="mobile_data_item is-center"><div class="mobile_data_link"><a href="/archives/"><div class="headline">Articles</div><div class="length_num">14</div></a></div></div></div><hr/></div></div><div id="body-wrap"><div id="sidebar"><i class="fas fa-arrow-right on" id="toggle-sidebar"></i><div class="sidebar-toc"><div class="sidebar-toc__title">Catalog</div><div class="sidebar-toc__progress"><span class="progress-notice">You've read</span><span class="progress-num">0</span><span class="progress-percentage">%</span><div class="sidebar-toc__progress-bar">     </div></div><div class="sidebar-toc__content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9F%BA%E6%9C%AC%E4%BF%A1%E6%81%AF"><span class="toc-number">1.</span> <span class="toc-text">基本信息</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E7%AE%80%E4%BB%8B"><span class="toc-number">2.</span> <span class="toc-text">简介</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%B5%81%E7%A8%8B%E5%9B%BE"><span class="toc-number">3.</span> <span class="toc-text">流程图</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%8A%A8%E6%80%81%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90"><span class="toc-number">4.</span> <span class="toc-text">动态行为分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%96%87%E4%BB%B6%E8%A1%8C%E4%B8%BA"><span class="toc-number">4.1.</span> <span class="toc-text">文件行为</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%9B%E7%A8%8B%E8%A1%8C%E4%B8%BA"><span class="toc-number">4.2.</span> <span class="toc-text">进程行为</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E8%AF%A6%E7%BB%86%E8%A1%8C%E4%B8%BA%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">详细行为分析</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E5%88%86%E6%9E%90"><span class="toc-number">5.1.</span> <span class="toc-text">代码执行分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%BC%95%E5%AF%BC%E5%88%86%E5%8C%BA%E7%AC%AC%E4%B8%80%E6%89%87%E5%8C%BA%E5%88%86%E6%9E%90"><span class="toc-number">5.2.</span> <span class="toc-text">引导分区第一扇区分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook-Ntldr%E5%88%86%E6%9E%90"><span class="toc-number">5.3.</span> <span class="toc-text">Hook Ntldr分析</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#Hook-Kernel%E5%88%86%E6%9E%90"><span class="toc-number">5.4.</span> <span class="toc-text">Hook Kernel分析</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%A0%B7%E6%9C%AC%E6%BA%AF%E6%BA%90"><span class="toc-number">6.</span> <span class="toc-text">样本溯源</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E9%87%8A%E6%94%BE%E6%96%87%E4%BB%B6%E4%BF%A1%E6%81%AF"><span class="toc-number">6.1.</span> <span class="toc-text">释放文件信息</span></a></li></ol></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%9F%A5%E6%9D%80%E6%96%B9%E6%A1%88"><span class="toc-number">7.</span> <span class="toc-text">查杀方案</span></a></li><li class="toc-item toc-level-1"><a class="toc-link" href="#%E6%80%BB%E7%BB%93"><span class="toc-number">8.</span> <span class="toc-text">总结</span></a></li></ol></div></div></div><header class="post-bg" id="page-header"><nav id="nav"><span id="blog_name"><a id="site-name" href="/">Hexo</a></span><span id="menus"><span class="close" id="toggle-menu"><a class="site-page"><i class="fas fa-bars fa-fw"></i></a></span></span></nav><div id="post-info"><div id="post-title"><div class="posttitle">MBR病毒分析报告</div></div><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">Created</span><time class="post-meta-date-created" datetime="2021-03-30T05:45:25.000Z" title="Created 2021-03-30 13:45:25">2021-03-30</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">Updated</span><time class="post-meta-date-updated" datetime="2021-03-30T11:05:22.196Z" title="Updated 2021-03-30 19:05:22">2021-03-30</time></span></div><div class="meta-secondline"> <span class="post-meta-separator">|</span><span class="post-meta-pv-cv"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">Post View:</span><span id="busuanzi_value_page_pv"></span></span></div></div></div></header><main class="layout_post" id="content-inner"><article id="post"><div class="post-content" id="article-container"><h1 id="基本信息"><a href="#基本信息" class="headerlink" title="基本信息"></a>基本信息</h1><p>报告名称：MBR病毒分析报告</p>
<p>报告更新日期：2019/11/04</p>
<p>样本发现日期：2019/10/20</p>
<p>样本格式：.exe</p>
<p>壳信息：ASPack壳</p>
<p>可能受到威胁的系统：Windows系列</p>
<p>分析环境及工具：win7 32位，BCompare，ProcessMonitor，火绒剑</p>

<table>
<thead>
<tr>
<th>FileName</th>
<th>FileType</th>
<th>FileSize</th>
<th>MD5</th>
<th>SHA1</th>
</tr>
</thead>
<tbody><tr>
<td>CF77CFFF025C3C0A819312B379BA0218</td>
<td>MBR病毒</td>
<td>307200 bytes</td>
<td>CF77CFFF025C3C0A819312B379BA0218</td>
<td>B91F990422D99F885C0AB399CA39A055D7F677BF</td>
</tr>
</tbody></table>
<h1 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h1><p style="text-indent:2em">该病毒的类型是MBR病毒，简单描述一下该病毒的特点，常规的病毒是在用户层通过执行病毒模块使之启动从而达到病毒作者目的。然而该类病毒在首次时将病毒文件写入硬盘，并写入几段代码来加载恶意的病毒文件。该篇描述了病毒是如何写入硬盘恶意数据和如何启动病毒文件，这类病毒一旦启动就非常难查杀，早期感染这种病毒，重新装系统是没有效果的，被人们称之为鬼影病毒。</p>


<h1 id="流程图"><a href="#流程图" class="headerlink" title="流程图"></a>流程图</h1><p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_1.png" alt="image"></p>
<h1 id="动态行为分析"><a href="#动态行为分析" class="headerlink" title="动态行为分析"></a>动态行为分析</h1><h2 id="文件行为"><a href="#文件行为" class="headerlink" title="文件行为"></a>文件行为</h2><ul>
<li>在同目录下生成同名的dll文件</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_2.png" alt="image"></p>
<ul>
<li>读写磁盘文件</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_3.png" alt="image"></p>
<ul>
<li>创建并写入临时文件数据</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_4.png" alt="image"></p>
<ul>
<li>文件大致内容</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_5.png" alt="image"></p>
<h2 id="进程行为"><a href="#进程行为" class="headerlink" title="进程行为"></a>进程行为</h2><ul>
<li>调用系统进程regsvr32.exe注册dll文件</li>
</ul>
<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_6.png" alt="image"></p>
<h1 id="详细行为分析"><a href="#详细行为分析" class="headerlink" title="详细行为分析"></a>详细行为分析</h1><h2 id="代码执行分析"><a href="#代码执行分析" class="headerlink" title="代码执行分析"></a>代码执行分析</h2><p style="text-indent:2em">病毒样本首先是有两层壳，采用ESP定律就能将壳顺利脱下来。在IDA中分析发病毒首先发现一个方法在频繁的使用，直接分析这个方法看到底做了什么。</p>
<p style="text-indent:2em">跟进去发现这个方法是在temp目录下创建一个名称为：00000218.tem的文件。并每执行一步操作，就向文件中写入信息，可通过该信息判断病毒执行到哪一步，错误提示以及失败原因。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_7.png" alt="image"></p>
<p style="text-indent:2em">之后是获取windows目录，如果没有获取到，给文件中加入什么样的提示信息。然后是获取驱动器C盘在物理上的偏移量。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_8.png" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_9.png" alt="image"></p>
<p style="text-indent:2em">接着病毒来到了一个几乎大部分病毒都会执行的操作，就是创建互斥体与检查互斥体。互斥体的名称为：Global\7BC8413E-DEF5-4BF6-9530-9EAD7F45338B</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_10.png" alt="image"></p>
<p style="text-indent:2em">通过拼接字符串的方式，获取字符串：\\.\PhysicalDrive0，后面会分析到循环执行，字符串是\\.\PhysicalDrive1、\\.\PhysicalDrive2 ......,这个代表着寻找主机当中的首个硬盘名称，也是主硬盘，但通常为C盘的所在位置。一般看到这个动作可以猜想到是想获取主机中MBR的位置。因为主机中的MBR在主硬盘的0扇区，调用函数createFileA就可以直接打开操作硬盘数据。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_11.png" alt="image"></p>
<p style="text-indent:2em">接着就是写入磁盘数据了，病毒共找了11次，但并不是每次都会写入恶意数据到这些硬盘中。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_12.png" alt="image"></p>
<p style="text-indent:2em">病毒在写入数据的过程当中，给磁盘的一系列数据进行的判断，有判断磁盘的扇区数，MBR的字节大小等。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_13.png" alt="image"></p>
<p style="text-indent:2em">将原本正常的MBR引导区的代码读入内存，并判断大小是否为0x200，之后判断结尾处是否为0xAA55的结束符，又判断了引导区的代码是否是已经写入过的恶意数据，如果这几个条件满足，则不写入数据，直接退出该方法。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_14.png" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_15.png" alt="image"></p>
<p style="text-indent:2em">循环4次将四个分区结构解析，获取4个分区的基本信息，包括是否为活动分区，分区的头和尾的偏移等数据，并将这些数据写入到开始时在临时目录中创建的文件中。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_16.png" alt="image"></p>
<p style="text-indent:2em">若没有获取到分区信息，则返回方法。并写入临时文件相应提示信息。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_17.png" alt="image"></p>
<p style="text-indent:2em">将原本正常的MBR数据保存到临时文件中。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_18.png" alt="image"></p>
<p style="text-indent:2em">此处是将三个地址：7800,7A00,7C00这三个地址原本的数据读取并写入临时文件中，这三个位置的数据初始状态下为0，所以在文件当中没有写入。代码逻辑中有如果数据全为0则不写入。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_19.png" alt="image"></p>
<p style="text-indent:2em">接着就是向正常内存中写入数据，一共分为5部分，按照代码逻辑来看，首先是在大地址9FFF00000(本机)中写入一个PE文件，之后将这个PE dump下来发现此PE是一个sys的驱动文件。接着是写入三段数据，这三段数据分别是在地址 7800,7A00,7C00处，其中7C00处是原本的MBR引导代码。其他两段数据之后分析。还有既然是MBR引导病毒，必然会修改MBR引导代码，0柱面0磁头1扇区上写入恶意的MBR引导代码，但并非全部是作者写入的，其中的硬盘基本信息还是从本机的数据拼接上去的，在不破坏计算机分区基本信息的前提下修改了MBR引导代码。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_20.png" alt="image"></p>
<p style="text-indent:2em">在写入数据之后，将文件设置成重启后自动删除，然后将本身的后缀改成.dll文件，在PE结构中将exe改成dll，之后将这个dll装在进内存中。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_21.png" alt="image"></p>
<p style="text-indent:2em">修改过MBR之后，病毒要做的应该是执行这些恶意代码，怎么执行呢，当然就是让电脑重启执行恶意的MBR数据，病毒巧妙的提升权限并调用函数InitiateSystemShutdownA执行关机操作，并在关机时给出提示大概是有信息需要更新的弹窗，使用户很难发现是病毒做的这些事情。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_22.png" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_23.png" alt="image"></p>
<p style="text-indent:2em">到这里基本可以反编译的代码已经差不多分析完毕了。但还是没有发现明显的目的性的恶意行为，大胆的猜想一下之后病毒所要做的事情，首先知道了在内存中写入了一个PE文件，通过观察其他三段数据的长度可以猜想到，真正有目的性的代码应该是在PE中，因为这三段代码的量不大，充其量三段代码是用来加载这个PE的。因为在启动主机的过程中，不会因为写入一个PE，主机就能自动加载这个PE。根据这个思路去分析接下来的代码。</p>

<h2 id="引导分区第一扇区分析"><a href="#引导分区第一扇区分析" class="headerlink" title="引导分区第一扇区分析"></a>引导分区第一扇区分析</h2><p style="text-indent:2em">首先理解了系统在启动过程中所要做的工作。病毒代码也是根据系统启动的流程去做相应的恶意操作，这样可以在不影响正常系统启动的前提下执行恶意数据。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_24.png" alt="image"></p>
<p style="text-indent:2em">熟悉了系统启动的过程，接下来就是分析代码，刚开的MBR代码是16进制的汇编代码，只是看代码的话并没有任何头绪，所以需要在IDA中对系统启动时进行动态调试，具体调试方法可以搜索：IDA+VMware调试MBR的方法，有详细的教程。</p>
<p style="text-indent:2em">调试开始断到7C00处，这里的代码是MBR启动的代码，同时也是上述所说的0柱面0磁头1扇区的代码，也是恶意代码的第一段在0000处写的数据，操作系统启动时，会自动将0000处的启动代码加载到7C00处，所以要断到这个位置。简述一下这段代码的内容，就是拷贝之前写入的数据和hook int13的操作，以及hook int13后执行的代码内容也在这一段中。下图拷贝了正常的MBR数据到指定位置。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_25.png" alt="image"></p>
<p style="text-indent:2em">拷贝的第二段代码，这段代码是写入内存的7800处的代码，此代码是hook ntldr的特征码位置。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_26.png" alt="image"></p>
<p style="text-indent:2em">拷贝的第三段代码，这段代码是写入内存的7A00处的代码，此代码是hook kernel的特征码位置。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_27.png" alt="image"></p>
<p style="text-indent:2em">在进行单步的时候，发现修改了int 13所在的偏移，也就是说系统在调用int 13的时候，会跳转到修改后的偏移位置，偏移为9F066，这个时候肯定在内存中跟过去看看这段内容什么，发现正是拷贝的第一段内容，继续单步发现程序调到正常的MBR代码，系统启动起来了。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_28.png" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_29.png" alt="image"></p>
<p style="text-indent:2em">此时想为什么启动起来了，因为在hook int13 之后，单步是不会不进去hook之后的代码，所需要做的就是在hook int 13的偏移位置下断点，在下一次系统执行int 13的时候，就能断下来分析hook后的代码。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_30.png" alt="image"></p>
<p style="text-indent:2em">断到上述位置之后分析其中的代码，注意此时还是在分析第一扇区的代码，简单的描述一下此代码的作用主要是执行完正常的int 13 代码，之后在搜索ntldr的特征码，对系统将要用的位置再进行hook操作。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_31.png" alt="image"></p>
<p style="text-indent:2em">此时发现hook之后拷贝的恶意代码，是我们分析的第二段代码，至此第1扇区的代码才算分析结束，总结下来这段代码的功能主要是：拷贝了其他的恶意数据，hook了int13以及hook后的代码，hook后的代码hook并拷贝了ntldr的特征码。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_32.png" alt="image"></p>
<h2 id="Hook-Ntldr分析"><a href="#Hook-Ntldr分析" class="headerlink" title="Hook Ntldr分析"></a>Hook Ntldr分析</h2><p style="text-indent:2em">利用同样的方法，在hook之后的地址上下断，运行起来这段恶意数据始终要被运行的，值得注意的是此时的代码可以切换成32bit分析，简单来说此段代码也是在进行hook操作。通过搜索特征码找到BlLoaderBlock这个变量，这个变量的结构中包含内核等信息，通过这些信息达到hook的目的。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_33.png" alt="image"><br><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_34.png" alt="image"></p>
<p style="text-indent:2em">特征码搜索到之后就是对内核进行hook操作，hook的特征码是call IoinitSystem，hook后的内容是第三段代码，此代码也是实现写入到内存中的恶意数据，至此第二段代码分析完毕。</p>


<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_35.png" alt="image"></p>
<h2 id="Hook-Kernel分析"><a href="#Hook-Kernel分析" class="headerlink" title="Hook Kernel分析"></a>Hook Kernel分析</h2><p style="text-indent:2em">之后是执行第三段的hook代码，首先执行这些数据是调用函数ExAllocatePool申请内存，然后将此段数据中的内容拷贝到申请的内存当中。然后跳转到申请的内存执行代码。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_36.png" alt="image"></p>
<p style="text-indent:2em">跳转到此段代码之后，首先执行的是系统函数IoInitSystem函数，为什么恶意代码中会有这个函数地址，往上面看刚刚分析过将这个函数地址保存到恶意数据中并复制到内存。调用这个函数是让系统初始化，初始化完成再进行病毒自己的操作。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_37.png" alt="image"></p>
<p style="text-indent:2em">调用系统函数NtOpenFile并传入参数，打开当前磁盘。并定位到驱动所在的位置。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_38.png" alt="image"></p>
<p style="text-indent:2em">搜索函数NtReadFile并申请内存空间，申请内存的地址是：85FD8000，将窗口定位到这个地址，之后调用读取函数将驱动的Pe文件拷贝到申请的内存当中。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_39.png" alt="image"></p>
<p style="text-indent:2em">将PE文件对齐到内存。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_40.png" alt="image"></p>
<p style="text-indent:2em">读取到PE的入口点偏移，并call进去执行驱动文件，然后执行驱动文件。</p>

<p><img src="https://cdn.jsdelivr.net/gh/HexLife/Picture-bed/MBR%20Virus%20analysis%20report/MBR%20Virus%20analysis%20report_41.png" alt="image"></p>
<p style="text-indent:2em">此时写入的几段数据全部分析完毕，与之前猜测的大致相同，总结一下就是此三段数据都是为了在系统启动过程中，将系统本来要执行的东西hook掉。换成恶意代码执行的数据，最终的目的是将写入的驱动文件执行起来，也是Rootkit的简单流程。</p>

<h1 id="样本溯源"><a href="#样本溯源" class="headerlink" title="样本溯源"></a>样本溯源</h1><h2 id="释放文件信息"><a href="#释放文件信息" class="headerlink" title="释放文件信息"></a>释放文件信息</h2><table>
<thead>
<tr>
<th>FileName</th>
<th>FileSize</th>
<th>MD5</th>
<th>SHA1</th>
</tr>
</thead>
<tbody><tr>
<td>1.dll</td>
<td>307200 bytes</td>
<td>E0264E4EE607A7C935DD07B30305B0A3</td>
<td>1890867720E3B545397CF64D856BFE035AF01DC8</td>
</tr>
<tr>
<td>MBR:0000</td>
<td>512 bytes</td>
<td>2FAB617E8963E52929F8060222B8A0D2</td>
<td>3E85B94A00468A9FD70A70317A1D822FD10D5358</td>
</tr>
<tr>
<td>MBR:7800</td>
<td>512 bytes</td>
<td>857B5C2882990C6BF71550A4760089E6</td>
<td>248F0C2736CFA50C0EB8AF0D0EC894CB81FD8107</td>
</tr>
<tr>
<td>MBR:7A00</td>
<td>512 bytes</td>
<td>D370DD485FC54DC4462695DVV33VD62E</td>
<td>63B4B2FC1FCBCF271DFFDAB5A0E389BD36BA7B97</td>
</tr>
<tr>
<td>MBR:7C00</td>
<td>512 bytes</td>
<td>24FE16547E6305C839708A1F8E2B21B8</td>
<td>75EC161E31EEB158477DF2C2A92CF2BB4E5EB819</td>
</tr>
</tbody></table>
<h1 id="查杀方案"><a href="#查杀方案" class="headerlink" title="查杀方案"></a>查杀方案</h1><ul>
<li>修复时利用工具winHex，按F9打开物理磁盘的第一个也就是HD0这块，将偏移为7C00处的数据回写到偏移为0000处，或者使用PowerTool32直接将0000处的数据修复</li>
<li>将偏移7800处的数据回写为0，大小为512字节</li>
<li>将偏移7A00处的数据回写为0，大小为512字节</li>
<li>将偏移7C00处的数据回写为0，大小为512字节</li>
<li>偏移9FFF00000的PE文件可作为垃圾数据处理<h1 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h1><p style="text-indent:2em">此类病毒顽固难杀，并且难以防范，注意日常的上网规范，不浏览不下载来路不明的程序或软件，对于比较重要的数据，应当定期备份，以防不测。若发现某程序试图修改主机MBR，则大有可能要写入感染病毒，此时应当提高警惕，不给病毒可乘之机。</p>
<p style="text-indent:2em">若感染此类病毒，应断开网络，找找病毒的关键字在正规的安全厂商处查找是否用相关病毒记录，以及公布的查杀方案，若没有线索则可将样本收集提交给相关分析人员，并获得相应查杀方案。避免造成更大的损失。</p></li>
</ul>
</div><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">Author: </span><span class="post-copyright-info"><a href="mailto:undefined">John Doe</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">Link: </span><span class="post-copyright-info"><a href="http://example.com/2021/03/30/MBR%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/">http://example.com/2021/03/30/MBR%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">Copyright Notice: </span><span class="post-copyright-info">All articles in this blog are licensed under <a target="_blank" rel="noopener" href="https://creativecommons.org/licenses/by-nc-sa/4.0/">CC BY-NC-SA 4.0</a> unless stating additionally.</span></div></div><div class="tag_share"><div class="post-meta__tag-list"></div><div class="post_share"><div class="social-share" data-image="/null" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/social-share.js/dist/css/share.min.css"><script src="https://cdn.jsdelivr.net/npm/social-share.js/dist/js/social-share.min.js" defer></script></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-left"><a href="/2021/03/30/%E8%A0%95%E8%99%AB%E7%97%85%E6%AF%92%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/"><img class="prev-cover" src="/null" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Previous Post</div><div class="prev_info">蠕虫病毒分析报告</div></div></a></div><div class="next-post pull-right"><a href="/2021/03/30/Revenge%20RAT%E8%BF%9C%E6%8E%A7%E6%9C%A8%E9%A9%AC%E5%88%86%E6%9E%90%E6%8A%A5%E5%91%8A/"><img class="next-cover" src="/null" onerror="onerror=null;src='/img/404.jpg'"><div class="pagination-info"><div class="label">Next Post</div><div class="next_info">Revenge RAT远控木马分析报告</div></div></a></div></nav></article></main><footer id="footer" data-type="color"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2021 By John Doe</div><div class="framework-info"><span>Framework </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>Theme </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a></div></div></footer></div><section id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="Read Mode"><i class="fas fa-book-open"></i></button><button id="darkmode" type="button" title="Switch Between Light And Dark Mode"><i class="fas fa-adjust"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="Setting"><i class="fas fa-cog"></i></button><button class="close" id="mobile-toc-button" type="button" title="Table Of Contents"><i class="fas fa-list-ul"></i></button><button id="go-up" type="button" title="Back To Top"><i class="fas fa-arrow-up"></i></button></div></section><div><script src="https://cdn.jsdelivr.net/npm/jquery@latest/dist/jquery.min.js"></script><script src="/js/utils.js"></script><script src="/js/main.js"></script><script src="https://cdn.jsdelivr.net/npm/@fancyapps/fancybox@latest/dist/jquery.fancybox.min.js"></script><div class="js-pjax"><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></div></div></body></html>